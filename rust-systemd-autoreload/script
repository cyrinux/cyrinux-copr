#! /bin/sh

set -ex

export COPR_PACKAGE

REPO_URL="https://git.sr.ht/~whynothugo/systemd-autoreload"
VERSION="0.1.0"

git config --global user.name "Cyril Levis"
git config --global user.email copr@levis.name

CRATE="${COPR_PACKAGE#rust-}"

# Clone repo and create source archive
git clone --depth=1 "${REPO_URL}" "${CRATE}"
(
    cd -- "${CRATE}"
    git archive --format=tar.gz -o ../"${CRATE}-${VERSION}.tar.gz" --prefix "${CRATE}-${VERSION}"/ main
)

# Create vendor and spec
rust2rpm -V ./"${CRATE}"

# Patch spec file
curl -s "https://raw.githubusercontent.com/cyrinux/cyrinux-copr/main/${COPR_PACKAGE}/${CRATE}.spec.diff" | git apply -v
